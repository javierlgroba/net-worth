<h1>Portfolio</h1>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<%= javascript_include_tag 'portfolio_chart' %>
<script type="text/javascript">
    document.addEventListener('turbolinks:load', function() {
        google.charts.load('current', {'packages':['corechart']});
    });

    document.addEventListener('turbolinks:before-cache', function() {
        google.charts.unload();
    });

    google.charts.load('current', {'packages':['corechart']});

    <% for currency, data in @portfolio_data do %>
        <% if !data[:chart_data][:symbols].empty? %>
            console.log('<%= FormatService.grouping_symbol %>');
            google.charts.setOnLoadCallback(function() {
                drawChart(
                    <%= raw data[:chart_data].to_json %>,
                    '<%= currency.id %>',
                    '<%= FormatService.prefix(Money::Currency.new(currency.id).symbol) %>',
                    '<%= FormatService.grouping_symbol %>',
                    '<%= FormatService.decimal_symbol %>',
                    '<%= FormatService.suffix(Money::Currency.new(currency.id).symbol) %>',
                );
            });
        <% end %>
    <% end %>
</script>

<% for currency, data in @portfolio_data do %>

    <h2>Invested in <%= currency.name %></h2>

    <% if !data[:chart_data][:symbols].empty? %>
        <div id="chart_div_<%= currency.id %>" style="width: 100%; height: 500px; overflow: hidden;"></div>
    <% end %>

    Total Invested: <%= data[:total_invested_amount].format(format: FormatService.currency_format) %><br>
    Total Current Value: <%= data[:total_current_value].format(format: FormatService.currency_format) %>
    <% if data[:diff].amount > 0 %>
        <span style="color: green;">+<%= data[:diff].format(format: FormatService.currency_format)  %></span>
    <% else %>
        <span style="color: red;"><%= data[:diff].format(format: FormatService.currency_format)  %></span>
    <% end %>

    <ul>
        <% data[:stocks].each do |stock| %>
            <li>
                <%= link_to stock.alias, stock %>
            </li>
        <% end %>
    </ul>

<% end %>

<%= link_to "Add Stock", new_stock_path %>
